import exif_reader
import gleam/json
import gleeunit
import gleeunit/should

pub fn main() -> Nil {
  gleeunit.main()
}

pub fn exif_data_decoder_test() {
  // Test basic metadata parsing
  let json_string =
    "{\n  \"SourceFile\": \"/path/to/test.jpg\",\n  \"ExifToolVersion\": 13.30,\n  \"FileName\": \"test.jpg\",\n  \"Directory\": \"/path/to\",\n  \"FileSize\": \"1196 kB\",\n  \"FileModifyDate\": \"2023:01:01 10:00:00-05:00\",\n  \"FileAccessDate\": \"2023:01:01 10:00:00-05:00\",\n  \"FileInodeChangeDate\": \"2023:01:01 10:00:00-05:00\",\n  \"FilePermissions\": \"-rw-r--r--\",\n  \"FileType\": \"JPEG\",\n  \"FileTypeExtension\": \"jpg\",\n  \"MIMEType\": \"image/jpeg\",\n  \"JFIFVersion\": 1.01,\n  \"ExifByteOrder\": \"Big-endian (Motorola, MM)\",\n  \"ImageDescription\": \"Sample image description\",\n  \"Make\": \"Example\",\n  \"Model\": \"Camera Model\",\n  \"Orientation\": \"Horizontal (normal)\",\n  \"XResolution\": 72,\n  \"YResolution\": 72,\n  \"ResolutionUnit\": \"inches\",\n  \"Software\": 18.5,\n  \"ModifyDate\": \"2023:01:01 10:00:00\",\n  \"HostComputer\": \"Computer Model\",\n  \"TileWidth\": 512,\n  \"TileLength\": 512,\n  \"YCbCrPositioning\": \"Centered\",\n  \"ExposureTime\": \"1/401\",\n  \"FNumber\": 2.2,\n  \"ExposureProgram\": \"Program AE\",\n  \"ISO\": 40,\n  \"ExifVersion\": \"0232\",\n  \"DateTimeOriginal\": \"2023:01:01 10:00:00\",\n  \"CreateDate\": \"2023:01:01 10:00:00\",\n  \"OffsetTime\": \"-05:00\",\n  \"OffsetTimeOriginal\": \"-05:00\",\n  \"OffsetTimeDigitized\": \"-05:00\",\n  \"ComponentsConfiguration\": \"Y, Cb, Cr, -\",\n  \"ShutterSpeedValue\": \"1/401\",\n  \"ApertureValue\": 2.2,\n  \"BrightnessValue\": 7.815160174,\n  \"ExposureCompensation\": 0,\n  \"MeteringMode\": \"Multi-segment\",\n  \"Flash\": \"Off, Did not fire\",\n  \"FocalLength\": \"2.2 mm\",\n  \"SubjectArea\": \"2012 1511 2217 1330\",\n  \"MakerNoteVersion\": 15,\n  \"RunTimeFlags\": \"Valid\",\n  \"RunTimeValue\": \"1000000000000000\",\n  \"RunTimeScale\": 1000000000,\n  \"RunTimeEpoch\": 0,\n  \"AEStable\": \"No\",\n  \"AETarget\": 183,\n  \"AEAverage\": 205,\n  \"AFStable\": \"Yes\",\n  \"AccelerationVector\": \"-0.9 -0.02 -0.15\",\n  \"ContentIdentifier\": \"00000000-0000-0000-0000-000000000000\",\n  \"ImageCaptureType\": \"Scene\",\n  \"LivePhotoVideoIndex\": 5000000,\n  \"PhotosAppFeatureFlags\": 0,\n  \"HDRHeadroom\": 1.00999999,\n  \"AFPerformance\": \"140 1 8\",\n  \"SignalToNoiseRatio\": 35.16557692,\n  \"PhotoIdentifier\": \"00000000-0000-0000-0000-000000000000\",\n  \"ColorTemperature\": 5671,\n  \"CameraType\": \"Back Normal\",\n  \"FocusPosition\": 52,\n  \"HDRGain\": 0.004659491126,\n  \"AFMeasuredDepth\": 171,\n  \"AFConfidence\": 96,\n  \"SemanticStyle\": \"{_0=1,_1=0,_2=0,_3=0}\",\n  \"SubSecTime\": 617,\n  \"SubSecTimeOriginal\": 617,\n  \"SubSecTimeDigitized\": 617,\n  \"FlashpixVersion\": \"0100\",\n  \"ColorSpace\": \"Uncalibrated\",\n  \"ExifImageWidth\": 4032,\n  \"ExifImageHeight\": 3024,\n  \"SensingMethod\": \"One-chip color area\",\n  \"SceneType\": \"Directly photographed\",\n  \"ExposureMode\": \"Auto\",\n  \"WhiteBalance\": \"Auto\",\n  \"FocalLengthIn35mmFormat\": \"14 mm\",\n  \"SceneCaptureType\": \"Standard\",\n  \"LensInfo\": \"2.220000029-15.65999985mm f/1.779999971-2.8\",\n  \"LensMake\": \"Example\",\n  \"LensModel\": \"Camera Model Lens 2.22mm f/2.2\",\n  \"CompositeImage\": \"General Composite Image\",\n  \"XMPToolkit\": \"XMP Core 6.0.0\",\n  \"Title\": \"Sample Image\",\n  \"Description\": \"Sample image description\",\n  \"Subject\": \"Test Subject\",\n  \"CreatorTool\": 18.5,\n  \"MPFVersion\": \"0100\",\n  \"NumberOfImages\": 2,\n  \"MPImageFlags\": \"(none)\",\n  \"MPImageFormat\": \"JPEG\",\n  \"MPImageType\": \"Undefined\",\n  \"MPImageLength\": 564691,\n  \"MPImageStart\": 631660,\n  \"DependentImage1EntryNumber\": 0,\n  \"DependentImage2EntryNumber\": 0,\n  \"ProfileCMMType\": \"Example Inc.\",\n  \"ProfileVersion\": \"4.0.0\",\n  \"ProfileClass\": \"Input Device Profile\",\n  \"ColorSpaceData\": \"RGB \",\n  \"ProfileConnectionSpace\": \"XYZ \",\n  \"ProfileDateTime\": \"2016:01:01 00:00:00\",\n  \"ProfileFileSignature\": \"acsp\",\n  \"PrimaryPlatform\": \"Example Inc.\",\n  \"CMMFlags\": \"Not Embedded, Independent\",\n  \"DeviceManufacturer\": \"Example Inc.\",\n  \"DeviceModel\": \"\",\n  \"DeviceAttributes\": \"Reflective, Glossy, Positive, Color\",\n  \"RenderingIntent\": \"Perceptual\",\n  \"ConnectionSpaceIlluminant\": \"0.9642 1 0.82491\",\n  \"ProfileCreator\": \"Example Inc.\",\n  \"ProfileID\": \"00000000000000000000000000000000\",\n  \"ProfileDescription\": \"Example Color Profile\",\n  \"ProfileCopyright\": \"Copyright Example Inc., 2016\",\n  \"MediaWhitePoint\": \"0.9642 1 0.8251\",\n  \"AToB2\": \"(Binary data 29772 bytes, use -b option to extract)\",\n  \"ChromaticAdaptation\": \"1.04781 0.02289 -0.05017 0.02953 0.99051 -0.01706 -0.00925 0.01506 0.75191\",\n  \"AToB0\": \"(Binary data 29772 bytes, use -b option to extract)\",\n  \"AToB1\": \"(Binary data 29772 bytes, use -b option to extract)\",\n  \"CurrentIPTCDigest\": \"00000000000000000000000000000000\",\n  \"CodedCharacterSet\": \"UTF8\",\n  \"ApplicationRecordVersion\": 2,\n  \"DigitalCreationDate\": \"2023:01:01\",\n  \"DigitalCreationTime\": \"10:00:00\",\n  \"ObjectName\": \"Sample Image\",\n  \"DateCreated\": \"2023:01:01\",\n  \"TimeCreated\": \"10:00:00-05:00\",\n  \"Caption-Abstract\": \"Sample image description\",\n  \"Keywords\": \"Test Subject\",\n  \"IPTCDigest\": \"00000000000000000000000000000000\",\n  \"ImageWidth\": 1280,\n  \"ImageHeight\": 960,\n  \"EncodingProcess\": \"Baseline DCT, Huffman coding\",\n  \"BitsPerSample\": 8,\n  \"ColorComponents\": 3,\n  \"YCbCrSubSampling\": \"YCbCr4:2:0 (2 2)\",\n  \"RunTimeSincePowerUp\": \"1 day 00:00:00\",\n  \"Aperture\": 2.2,\n  \"ImageSize\": \"1280x960\",\n  \"Megapixels\": 1.2,\n  \"ScaleFactor35efl\": 6.3,\n  \"ShutterSpeed\": \"1/401\",\n  \"SubSecCreateDate\": \"2023:01:01 10:00:00.617-05:00\",\n  \"SubSecDateTimeOriginal\": \"2023:01:01 10:00:00.617-05:00\",\n  \"SubSecModifyDate\": \"2023:01:01 10:00:00.617-05:00\",\n  \"DateTimeCreated\": \"2023:01:01 10:00:00-05:00\",\n  \"DigitalCreationDateTime\": \"2023:01:01 10:00:00\",\n  \"MPImage2\": \"(Binary data 564691 bytes, use -b option to extract)\",\n  \"CircleOfConfusion\": \"0.005 mm\",\n  \"FOV\": \"104.3 deg\",\n  \"FocalLength35efl\": \"2.2 mm (35 mm equivalent: 14.0 mm)\",\n  \"HyperfocalDistance\": \"0.47 m\",\n  \"LightValue\": 12.2,\n  \"LensID\": \"Camera Model Lens 2.22mm f/2.2\"\n}"
  let result =
    json.parse(from: json_string, using: exif_reader.exif_data_decoder())

  should.be_ok(result)

  case result {
    Ok(exif_data) -> {
      // Check basic metadata fields
      exif_data.source_file
      |> should.equal("/path/to/test.jpg")

      exif_data.file_name
      |> should.equal("test.jpg")
    }
    Error(_) -> should.fail()
  }
}
